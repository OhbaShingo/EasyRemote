<html>
	<script>
		let g_scale;	// スケール(画像表示倍率)

		let g_lastMoveTime = 0;
		let g_lastX;
		let g_lastY;
		let g_lastButton;
		let g_draging;
		let g_cancelTimer = null;

		// 画像読込完了
		function onImageLoad() {
			const img = document.getElementById('captureImg');
			// 左右クリックイベント
			img.addEventListener('pointerdown', sendMouseOnOff);
			img.addEventListener('pointerup', sendMouseOnOff);
			img.addEventListener("pointermove", sentMouseMove);
			img.addEventListener("pointercancel", sendMouseCancel);
			img.addEventListener("pointerout", sendMouseCancel);
			img.addEventListener("pointerleave", sendMouseCancel);

			img.addEventListener('wheel', sendMouseWheel);
			g_draging = false;

			updateStatus();

			resizeImg();
		}

		// 状態取得（左エリアを表示するか否か）
    	async function updateStatus() {
    		try {
	        	const res = await fetch("/status");
	        	if (!res.ok) throw new Error("HTTPエラー");
	        	const json = await res.json();

	        	const statusText = document.getElementById("statusText");
	        	const actionBtn  = document.getElementById("actionBtn");

	        	if (json.ShowOnly) {
					document.getElementById( "statusArea" ).style.display = "none";
	        	}
	      	} catch (e) {
	        	console.error("状態取得失敗:", e);
    		}
    	}

		// リサイズ
		function onResize() {
			resizeImg();
		}

		// 画像リサイズ
		function resizeImg() 
		{
		    const img = document.getElementById('captureImg');
		    const div = document.getElementById('image');
		    if (!img.complete || !img.naturalWidth) return;

		    const divW = div.clientWidth;
		    const divH = div.clientHeight;
		    const imgW = img.naturalWidth;
		    const imgH = img.naturalHeight;

		    // 同倍率でdivに収まるように
		    g_scale = Math.min(divW / imgW, divH / imgH);
		    const newW = imgW * g_scale;
		    const newH = imgH * g_scale;

		    // 左上に配置
		    img.style.left = "0px";
		    img.style.top = "0px";
		    img.style.width = `${newW}px`;
		    img.style.height = `${newH}px`;
		    console.log("scale=${g_scale.toFixed(3)} size=${newW}x${newH}");
		    console.log( "画像サイズWidth=" + imgW + " Height=" + imgH );
		}

		//
		// マウスボタン ON/OFF
		//
		function sendMouseCancel( event )
		{
			if( g_draging == true ) {
			    fetch("/mouse", {
			        method: "POST",
			        headers: { "Content-Type": "application/json" },
			        body: JSON.stringify({
			            type: "pointerup",   // "mousedown" or "mouseup"
			            button:g_lastButton,
			            x:g_lastX, y:g_lastY
			        })
			    });
			    g_draging = false;
				clearPointerWatch();
			}
		}

		//
		// マウスボタン ON/OFF
		//
		function sendMouseOnOff( event )
		{
    		const rect = event.target.getBoundingClientRect();
    		const x = ( event.clientX - rect.left ) / g_scale;
    		const y = ( event.clientY - rect.top ) / g_scale;

    		let button;
    		switch (event.button) {
        		case 0: button = "left"; break;
        		case 1: button = "middle"; break;
        		case 2: button = "right"; break;
    		}
			if( event.type == "pointerdown" ) {
				g_lastX = x;
				g_lastY = y;
	    		g_lastButton = button;
				document.getElementById('lastX').value = g_lastX;
				document.getElementById('lastY').value = g_lastY;
    			g_draging = true;

				g_lastMoveTime = Date.now();
				startPointerWatch(event);
	        	console.error("タッチ = " + g_lastMoveTime );
			}
			if( event.type == "pointerup" ) {
				clearPointerWatch();
    			g_draging = false;
			}

		    fetch("/mouse", {
		        method: "POST",
		        headers: { "Content-Type": "application/json" },
		        body: JSON.stringify({
		            type: event.type,   // "mousedown" or "mouseup"
		            button,
		            x, y
		        })
		    });
		}

		//
		// マウス移動
		//
		function sentMouseMove( event )
		{
    		const rect = event.target.getBoundingClientRect();
    		const x = ( event.clientX - rect.left ) / g_scale;
    		const y = ( event.clientY - rect.top ) / g_scale;
    		const button = " ";

			let diffX = Math.abs( x - g_lastX );
			let diffY = Math.abs( y - g_lastY );
			if( diffX > 5 || diffY > 5 ) {
				g_lastX = x;
				g_lastY = y;
				document.getElementById('lastX').value = g_lastX;
				document.getElementById('lastY').value = g_lastY;
			}
			g_lastMoveTime = Date.now();	// 最終移動時間
        	console.error("移動 = " + g_lastMoveTime );

			fetch("/mouse", {
			    method: "POST",
			    headers: { "Content-Type": "application/json" },
			    body: JSON.stringify({
			        type: event.type,   // "mousedown" or "mouseup"
			        button,
			        x, y
			    })
			});
		}

		// --- タイマー監視 ---
		function startPointerWatch(event) {
    		clearPointerWatch();
    		g_cancelTimer = setInterval(() => {
				let nowTime = Date.now()
				let diff = nowTime - g_lastMoveTime;
		        console.error("タイムアウト確認 差分=" + diff + "( 現在=" + nowTime );
        		if ( ( g_draging == true ) && ( diff > 1000 ) ) {
		        	console.error("タイムアウトによるsendMouseCancel NowTime=" + nowTime + " last=" + g_lastMoveTime );
        			sendMouseCancel();
        		}
    		}, 50); // 50 ms周期で監視
		}

		function clearPointerWatch() {
    		if (g_cancelTimer) {
        		clearInterval(g_cancelTimer);
        		g_cancelTimer = null;
    		}
		}


		//
		// マウスホイール
		//
		function sendMouseWheel( event ) 
		{
		    const rect = event.target.getBoundingClientRect();
		    const x = (event.clientX - rect.left) / g_scale;
		    const y = (event.clientY - rect.top) / g_scale;
		    fetch("/mouse", {
    		    method: "POST",
		        headers: { "Content-Type": "application/json" },
		        body: JSON.stringify({
		            type: "wheel",
		            delta: event.deltaY,
		            x, y
		        })
		    });			
		}


	</script>

	<style>
		html, body {
		    height: 100%;
		    margin: 0;
		}
		body {
		    display: flex;
		    flex-direction: row;
		}
		#control {
		    padding: 4px;
		}
		#image {
		    flex: 1;
		    position: relative;
		    overflow: hidden;
		    background-color: #222;
		}
		#captureImg {
		    position: absolute;
		    left: 0;
		    top: 0;
		    display: block;
		    max-width: none;
		    max-height: none;
		    touch-action: manipulation; /* ← ズームやダブルタップ拡大を許可 */
  			user-select: none;          /* 長押しでの選択防止 */

		}
	</style>

	<head>
	    <title>簡易リモートアクセス アクセス中</title>
	</head>

	<body onresize="onResize()">
		<div id="statusArea">
			スマートフォン用<br>
			キー入力エリア<br>
			<input type="text">
			<br>
			<br>
			マウス操作<br>
			<input type="checkbox" id="mouse_click">クリック維持<br>
			<br>
			<br>
			<div id="debug_area">
				X<input type="number" id="lastX"><br>
				Y<input type="number" id="lastY"><br>
			</div>

		</div>
		<div id="image">
			<img id="captureImg" src="/capturejpeg" onload="onImageLoad()">
		</div>


	</body>

</html>